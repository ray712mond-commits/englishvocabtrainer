<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // =========================================================
        // !!! ğŸš¨ é€™è£¡éœ€è¦è²¼ä¸Šæ‚¨å¾ Firebase å°ˆæ¡ˆè¤‡è£½çš„è¨­å®šè³‡è¨Š !!!
        // è«‹ç¢ºä¿æ‚¨å·²å°‡æ‰€æœ‰ YOUR_FIREBASE_CONFIG_... æ›¿æ›æˆå¯¦éš›é‡‘é‘°
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbmwpXx0mnZDd5xOcc2qlc3BkrE7_VFVw", // <--- æ›¿æ›é€™è£¡
            authDomain: "englishvocabtrainer-b1de4.firebaseapp.com", // <--- æ›¿æ›é€™è£¡
            projectId: "englishvocabtrainer-b1de4", // <--- æ›¿æ›é€™è£¡
            storageBucket: "englishvocabtrainer-b1de4.firebasestorage.app",
            messagingSenderId: "415372743931",
            appId: "1:415372743931:web:3a734463227111d5704c5e"
        };

        // å‚³çµ±åˆå§‹åŒ–æ–¹å¼
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore(); // å–å¾— Firestore æœå‹™

        // å°‡æ‰€æœ‰éœ€è¦çš„å‡½å¼å’Œç‰©ä»¶éƒ½å°å‡ºåˆ°å…¨åŸŸï¼Œä¾›ä¸‹æ–¹çš„ä¸»é‚è¼¯ä½¿ç”¨
        window.db = db;
        window.vocabCollection = db.collection("vocabWords");
    </script>

    <script>
        // ** å…¨åŸŸè®Šæ•¸ **
        let vocabList = [];
        let currentQuiz = []; 
        let currentQuestionIndex = 0;
        let quizSettings = {};
        let correctAnswers = 0;

        let totalHintsUsed = 0; 
        let hintLimit = 3; 
        let editingWord = null; 

        // ** è³‡æ–™å„²å­˜ (ä½¿ç”¨ Firebase Firestore) **
        
        /** å•Ÿå‹•å³æ™‚ç›£è½ï¼Œå¾ Firestore è®€å–æ‰€æœ‰å–®å­—ä¸¦æ›´æ–°å…¨åŸŸè®Šæ•¸ */
        function startRealtimeListener() {
            // æª¢æŸ¥å…¨åŸŸè®Šæ•¸æ˜¯å¦å·²åˆå§‹åŒ–
            if (!window.db || !window.vocabCollection) {
                console.error("Firebase å‡½å¼åº«æœªè¼‰å…¥ï¼è«‹æª¢æŸ¥ CDN è…³æœ¬æ˜¯å¦æ­£ç¢ºã€‚");
                document.getElementById('vocabCount').textContent = 'è¼‰å…¥å¤±æ•— (Firebase éŒ¯èª¤)';
                return;
            }

            // ä½¿ç”¨å‚³çµ±çš„ onSnapshot ç›£è½æ–¹å¼
            window.vocabCollection.onSnapshot((snapshot) => {
                vocabList = [];
                snapshot.forEach((doc) => {
                    vocabList.push({ id: doc.id, ...doc.data() });
                });
                // è®“å–®å­—æ¸…å–®æŒ‰è‹±æ–‡å–®å­—å­—æ¯æ’åºï¼Œæ–¹ä¾¿æŸ¥æ‰¾
                vocabList.sort((a, b) => a.word.localeCompare(b.word));
                
                renderVocabList(); 
            }, (error) => {
                console.error("Error listening to Firestore: ", error);
                document.getElementById('vocabCount').textContent = 'è¼‰å…¥å¤±æ•—';
            });
        }

        // ** 1. ä¸Šå‚³/æ›´æ–°å–®å­—åŠŸèƒ½ (å¯«å…¥ Firestore) **

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            
            const newWordData = {
                word: document.getElementById('word').value.trim(),
                meaning: document.getElementById('meaning').value.trim(),
                partOfSpeech: document.getElementById('partOfSpeech').value,
                context: document.getElementById('context').value.trim(),
            };

            const msg = document.getElementById('uploadMessage');

            try {
                if (editingWord) {
                    // ä¿®æ”¹ç¾æœ‰å–®å­—
                    await window.vocabCollection.doc(editingWord.id).update(newWordData);
                    msg.textContent = `æˆåŠŸæ›´æ–°å–®å­—: ${newWordData.word}`;
                } else {
                    // æ–°å¢å–®å­—
                    
                    // æª¢æŸ¥å–®å­—æ˜¯å¦å·²ç¶“å­˜åœ¨
                    const existing = vocabList.find(v => v.word.toLowerCase() === newWordData.word.toLowerCase());
                    if (existing) {
                        alert(`å–®å­— "${newWordData.word}" å·²ç¶“å­˜åœ¨æ–¼æ¸…å–®ä¸­ï¼`);
                        submitButton.disabled = false;
                        return;
                    }

                    await window.vocabCollection.add({ ...newWordData, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    msg.textContent = `æˆåŠŸå„²å­˜å–®å­—: ${newWordData.word} (å·²åŒæ­¥åˆ°é›²ç«¯)`;
                }

                // æ¸…ç†ç‹€æ…‹
                document.getElementById('uploadForm').reset();
                resetUploadState(); 
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
                
            } catch (error) {
                console.error("Error saving document: ", error);
                alert("å„²å­˜/æ›´æ–°å¤±æ•—ï¼è«‹æª¢æŸ¥ Firebase è¨­å®šã€æ¬Šé™æˆ–ç¶²è·¯é€£ç·šã€‚");
            } finally {
                submitButton.disabled = false;
            }
        });

        /** é‡è¨­ä¸Šå‚³è¡¨å–®çš„ç‹€æ…‹ */
        function resetUploadState() {
            editingWord = null;
            document.getElementById('uploadForm').querySelector('button[type="submit"]').textContent = 'å„²å­˜å–®å­—';
            document.getElementById('uploadTab').querySelector('h2').textContent = 'ä¸Šå‚³æ–°å–®å­—';
        }


        // ** 3. å–®å­—æ¸…å–®é¡¯ç¤º/æ“ä½œ **

        /** æ¸²æŸ“å–®å­—æ¸…å–®è¡¨æ ¼ */
        function renderVocabList() {
            const tbody = document.getElementById('vocabTable').querySelector('tbody');
            tbody.innerHTML = '';
            document.getElementById('vocabCount').textContent = vocabList.length;

            vocabList.forEach(vocab => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${vocab.word} (${vocab.partOfSpeech})</td>
                    <td>${vocab.meaning}</td>
                    <td>${vocab.context}</td>
                    <td>
                        <button style="background-color: #007bff; margin-right: 5px;" onclick="editVocab('${vocab.id}')">ä¿®æ”¹</button>
                        <button style="background-color: #dc3545;" onclick="deleteVocab('${vocab.id}')">åˆªé™¤</button>
                    </td>
                `;
            });
        }

        /** ç·¨è¼¯å–®å­— */
        function editVocab(docId) {
            const vocab = vocabList.find(v => v.id === docId);
            if (!vocab) return;

            editingWord = vocab;
            
            document.getElementById('word').value = vocab.word;
            document.getElementById('meaning').value = vocab.meaning;
            document.getElementById('partOfSpeech').value = vocab.partOfSpeech;
            document.getElementById('context').value = vocab.context;

            document.getElementById('uploadForm').querySelector('button[type="submit"]').textContent = 'æ›´æ–°å–®å­—';
            document.getElementById('uploadTab').querySelector('h2').textContent = `ä¿®æ”¹å–®å­—: ${vocab.word}`;

            openTab(null, 'uploadTab');
        }

        /** åˆªé™¤å–®å­— (å¾ Firestore åˆªé™¤) */
        async function deleteVocab(docId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å–®å­—å—ï¼Ÿæ­¤æ“ä½œæœƒå¾å…±äº«è³‡æ–™åº«ä¸­æ°¸ä¹…ç§»é™¤ï¼')) {
                try {
                    await window.vocabCollection.doc(docId).delete();
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    alert("åˆªé™¤å¤±æ•—ï¼è«‹æª¢æŸ¥ Firebase é€£ç·šæˆ–æ¬Šé™ã€‚");
                }
            }
        }

        // ** 2. æŠ½è€ƒåŠŸèƒ½ (ä»¥ä¸‹é‚è¼¯ä¸è®Š) **

        /** åˆå§‹åŒ–æ¸¬é©—è¨­å®šä¸¦æº–å‚™é¡Œç›® */
        function startQuiz() {
            if (vocabList.length === 0) {
                alert('å–®å­—æ¸…å–®æ˜¯ç©ºçš„ï¼Œè«‹å…ˆä¸Šå‚³å–®å­—ï¼Œæˆ–ç­‰å¾…è³‡æ–™åº«è¼‰å…¥å®Œæˆï¼');
                return;
            }

            const count = parseInt(document.getElementById('quizCount').value);
            const rangeText = document.getElementById('quizRange').value.trim();
            
            hintLimit = parseInt(document.getElementById('hintLimit').value); 
            totalHintsUsed = 0; 

            quizSettings = {
                count: Math.min(count, vocabList.length), 
                range: rangeText ? rangeText.toLowerCase().split(',').map(s => s.trim()) : [],
                hintLimit: Math.min(Math.max(hintLimit, 1), 5) 
            };

            let filteredVocab = vocabList;
            if (quizSettings.range.length > 0 && quizSettings.range[0] !== "") {
                filteredVocab = vocabList.filter(vocab => {
                    return quizSettings.range.some(keyword => 
                        vocab.word.toLowerCase().includes(keyword) || 
                        vocab.meaning.includes(keyword)
                    );
                });
            }

            if (filteredVocab.length === 0) {
                alert('æ‰¾ä¸åˆ°ç¬¦åˆç¯„åœçš„å–®å­—ï¼Œè«‹ä¿®æ”¹æŠ½è€ƒç¯„åœï¼');
                return;
            }

            currentQuiz = [];
            const availableVocab = [...filteredVocab]; 
            for (let i = 0; i < quizSettings.count; i++) {
                const randomIndex = Math.floor(Math.random() * availableVocab.length);
                const selectedVocab = availableVocab.splice(randomIndex, 1)[0];
                const type = Math.floor(Math.random() * 2);
                currentQuiz.push({
                    ...selectedVocab,
                    type: type,
                    isCorrect: false,
                    hintsUsed: 0, 
                    studentInput: ''
                });
                if (availableVocab.length === 0) break;
            }

            currentQuestionIndex = 0;
            correctAnswers = 0;
            document.getElementById('quizArea').style.display = 'block';
            document.getElementById('quizResult').style.display = 'none';

            loadQuestion();
            openTab(null, 'quizSetupTab'); 
        }

        /** è¼‰å…¥ç•¶å‰é¡Œç›® */
        function loadQuestion() {
            if (currentQuestionIndex >= currentQuiz.length) {
                endQuiz();
                return;
            }

            const currentQ = currentQuiz[currentQuestionIndex];

            document.getElementById('quizScore').textContent = `ç¬¬ ${currentQuestionIndex + 1} é¡Œ / å…± ${currentQuiz.length} é¡Œ`;
            document.getElementById('studentAnswer').value = '';
            document.getElementById('quizFeedback').style.display = 'none';
            document.getElementById('correctAnswer').style.display = 'none';
            document.getElementById('nextButton').style.display = 'none';
            document.getElementById('hintArea').textContent = '';
            document.getElementById('studentAnswer').disabled = false;
            document.querySelector('#quizArea button:nth-child(5)').disabled = false; 

            document.getElementById('hintRemaining').textContent = hintLimit - totalHintsUsed;
            if (totalHintsUsed >= hintLimit) {
                document.getElementById('hintButton').style.display = 'none';
            } else {
                document.getElementById('hintButton').style.display = 'inline-block';
            }

            let questionText = "";
            let quizType = "";
            if (currentQ.type === 0) { 
                quizType = "çœ‹è‹±æ–‡å¯«ä¸­æ–‡æ„æ€";
                questionText = `${currentQ.word} (${currentQ.partOfSpeech}) çš„ä¸­æ–‡æ„æ€æ˜¯ï¼Ÿ`;
            } else { 
                quizType = "çœ‹ä¸­æ–‡æ„æ€å¯«è‹±æ–‡å–®å­—";
                questionText = `ã€Œ${currentQ.meaning}ã€çš„è‹±æ–‡å–®å­—æ˜¯ï¼Ÿ`;
            }
            document.getElementById('quizType').textContent = `[é¡Œå‹] ${quizType}`;
            document.getElementById('quizQuestion').textContent = questionText;
        }

        /** é¡¯ç¤ºæç¤º */
        function showHint() {
            if (totalHintsUsed < hintLimit) {
                totalHintsUsed++;
                currentQuiz[currentQuestionIndex].hintsUsed++; 
                
                document.getElementById('hintArea').textContent = `æƒ…å¢ƒæç¤ºï¼š${currentQuiz[currentQuestionIndex].context}`;
                document.getElementById('hintRemaining').textContent = hintLimit - totalHintsUsed;
            }

            if (totalHintsUsed >= hintLimit) {
                document.getElementById('hintButton').style.display = 'none';
            }
        }

        /** é€å‡ºç­”æ¡ˆä¸¦æ‰¹æ”¹ (é‚è¼¯ä¸è®Š) */
        function submitAnswer() {
            const studentAnswer = document.getElementById('studentAnswer').value.trim();
            const currentQ = currentQuiz[currentQuestionIndex];
            
            let isCorrect = false;
            let correctAnswerText = '';

            if (currentQ.type === 0) { 
                correctAnswerText = currentQ.meaning;
                isCorrect = correctAnswerText.toLowerCase().includes(studentAnswer.toLowerCase());
            } else { 
                correctAnswerText = currentQ.word;
                isCorrect = studentAnswer.toLowerCase() === correctAnswerText.toLowerCase();
            }

            const feedback = document.getElementById('quizFeedback');
            const correctDisplay = document.getElementById('theAnswer');
            
            feedback.style.display = 'block';
            document.getElementById('correctAnswer').style.display = 'block';
            document.getElementById('nextButton').style.display = 'inline-block';
            document.getElementById('hintButton').style.display = 'none';
            document.getElementById('studentAnswer').disabled = true;
            document.querySelector('#quizArea button:nth-child(5)').disabled = true; 
            
            correctDisplay.textContent = correctAnswerText;

            if (isCorrect && !currentQ.isCorrect) { 
                feedback.className = 'feedback correct';
                feedback.textContent = 'âœ… æ­£ç¢ºï¼ç­”å°äº†ï¼';
                correctAnswers++;
                currentQ.isCorrect = true; 
            } else if (isCorrect && currentQ.isCorrect) {
                feedback.className = 'feedback correct';
                feedback.textContent = 'âœ… æ­£ç¢ºï¼';
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'âŒ éŒ¯èª¤ï¼è«‹çœ‹æ­£ç¢ºç­”æ¡ˆï¼Œæˆ–é»é¸ä¸‹ä¸€é¡Œã€‚';
            }

            currentQ.studentInput = studentAnswer;
        }

        /** é€²å…¥ä¸‹ä¸€é¡Œ */
        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        /** çµæŸæ¸¬é©— */
        function endQuiz() {
            document.getElementById('quizArea').style.display = 'none';
            const resultDisplay = document.getElementById('quizResult');
            resultDisplay.style.display = 'block';
            resultDisplay.innerHTML = `
                æ¸¬é©—çµæŸï¼<br>
                ç¸½å…± ${currentQuiz.length} é¡Œï¼Œç­”å° ${correctAnswers} é¡Œã€‚<br>
                æ­£ç¢ºç‡ï¼š${((correctAnswers / currentQuiz.length) * 100).toFixed(1)}%
                <hr>
                <h4>æ¸¬é©—çµæœè©³æƒ…ï¼š</h4>
            `;
            
            currentQuiz.forEach((q, index) => {
                const correctAnswer = q.type === 0 ? q.meaning : q.word;
                const questionPrompt = q.type === 0 ? q.word : q.meaning;
                const status = q.isCorrect ? 'âœ… ç­”å°' : 'âŒ ç­”éŒ¯';
                const statusColor = q.isCorrect ? 'green' : 'red';
                resultDisplay.innerHTML += `
                    <p style="border-left: 4px solid ${statusColor}; padding-left: 10px;">
                        <strong>${index + 1}. ${questionPrompt}</strong> <span style="color: ${statusColor};">(${status})</span><br>
                        æ‚¨çš„ç­”æ¡ˆ: ${q.studentInput || 'æœªä½œç­”'} <br>
                        æ­£ç¢ºç­”æ¡ˆ: ${correctAnswer} (${q.partOfSpeech})<br>
                        æç¤ºä½¿ç”¨: ${q.hintsUsed} æ¬¡
                    </p>
                `;
            });
        }

        // ** ä»‹é¢æ§åˆ¶ **

        /** Tab åˆ‡æ›åŠŸèƒ½ */
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) {
                evt.currentTarget.className += " active";
            } else {
                document.querySelector(`.tab-button[onclick*="${tabName}"]`).className += " active";
            }

            if (tabName === 'uploadTab' && !editingWord) {
                resetUploadState();
            }
        }

        // åˆå§‹åŒ–ï¼šå•Ÿå‹•å³æ™‚è³‡æ–™åº«ç›£è½
        window.onload = function() {
            // ç”±æ–¼æ¡ç”¨å‚³çµ± CDN æ–¹å¼ï¼Œæˆ‘å€‘çŸ¥é“åˆå§‹åŒ–æœƒå…ˆæ–¼æ­¤è™•åŸ·è¡Œ
            startRealtimeListener();
            openTab(null, 'uploadTab'); 
        };
    </script>
