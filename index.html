<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // =========================================================
        // !!! 🚨 這裡需要貼上您從 Firebase 專案複製的設定資訊 !!!
        // 請確保您已將所有 YOUR_FIREBASE_CONFIG_... 替換成實際金鑰
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbmwpXx0mnZDd5xOcc2qlc3BkrE7_VFVw", // <--- 替換這裡
            authDomain: "englishvocabtrainer-b1de4.firebaseapp.com", // <--- 替換這裡
            projectId: "englishvocabtrainer-b1de4", // <--- 替換這裡
            storageBucket: "englishvocabtrainer-b1de4.firebasestorage.app",
            messagingSenderId: "415372743931",
            appId: "1:415372743931:web:3a734463227111d5704c5e"
        };

        // 傳統初始化方式
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore(); // 取得 Firestore 服務

        // 將所有需要的函式和物件都導出到全域，供下方的主邏輯使用
        window.db = db;
        window.vocabCollection = db.collection("vocabWords");
    </script>

    <script>
        // ** 全域變數 **
        let vocabList = [];
        let currentQuiz = []; 
        let currentQuestionIndex = 0;
        let quizSettings = {};
        let correctAnswers = 0;

        let totalHintsUsed = 0; 
        let hintLimit = 3; 
        let editingWord = null; 

        // ** 資料儲存 (使用 Firebase Firestore) **
        
        /** 啟動即時監聽，從 Firestore 讀取所有單字並更新全域變數 */
        function startRealtimeListener() {
            // 檢查全域變數是否已初始化
            if (!window.db || !window.vocabCollection) {
                console.error("Firebase 函式庫未載入！請檢查 CDN 腳本是否正確。");
                document.getElementById('vocabCount').textContent = '載入失敗 (Firebase 錯誤)';
                return;
            }

            // 使用傳統的 onSnapshot 監聽方式
            window.vocabCollection.onSnapshot((snapshot) => {
                vocabList = [];
                snapshot.forEach((doc) => {
                    vocabList.push({ id: doc.id, ...doc.data() });
                });
                // 讓單字清單按英文單字字母排序，方便查找
                vocabList.sort((a, b) => a.word.localeCompare(b.word));
                
                renderVocabList(); 
            }, (error) => {
                console.error("Error listening to Firestore: ", error);
                document.getElementById('vocabCount').textContent = '載入失敗';
            });
        }

        // ** 1. 上傳/更新單字功能 (寫入 Firestore) **

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            
            const newWordData = {
                word: document.getElementById('word').value.trim(),
                meaning: document.getElementById('meaning').value.trim(),
                partOfSpeech: document.getElementById('partOfSpeech').value,
                context: document.getElementById('context').value.trim(),
            };

            const msg = document.getElementById('uploadMessage');

            try {
                if (editingWord) {
                    // 修改現有單字
                    await window.vocabCollection.doc(editingWord.id).update(newWordData);
                    msg.textContent = `成功更新單字: ${newWordData.word}`;
                } else {
                    // 新增單字
                    
                    // 檢查單字是否已經存在
                    const existing = vocabList.find(v => v.word.toLowerCase() === newWordData.word.toLowerCase());
                    if (existing) {
                        alert(`單字 "${newWordData.word}" 已經存在於清單中！`);
                        submitButton.disabled = false;
                        return;
                    }

                    await window.vocabCollection.add({ ...newWordData, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    msg.textContent = `成功儲存單字: ${newWordData.word} (已同步到雲端)`;
                }

                // 清理狀態
                document.getElementById('uploadForm').reset();
                resetUploadState(); 
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
                
            } catch (error) {
                console.error("Error saving document: ", error);
                alert("儲存/更新失敗！請檢查 Firebase 設定、權限或網路連線。");
            } finally {
                submitButton.disabled = false;
            }
        });

        /** 重設上傳表單的狀態 */
        function resetUploadState() {
            editingWord = null;
            document.getElementById('uploadForm').querySelector('button[type="submit"]').textContent = '儲存單字';
            document.getElementById('uploadTab').querySelector('h2').textContent = '上傳新單字';
        }


        // ** 3. 單字清單顯示/操作 **

        /** 渲染單字清單表格 */
        function renderVocabList() {
            const tbody = document.getElementById('vocabTable').querySelector('tbody');
            tbody.innerHTML = '';
            document.getElementById('vocabCount').textContent = vocabList.length;

            vocabList.forEach(vocab => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${vocab.word} (${vocab.partOfSpeech})</td>
                    <td>${vocab.meaning}</td>
                    <td>${vocab.context}</td>
                    <td>
                        <button style="background-color: #007bff; margin-right: 5px;" onclick="editVocab('${vocab.id}')">修改</button>
                        <button style="background-color: #dc3545;" onclick="deleteVocab('${vocab.id}')">刪除</button>
                    </td>
                `;
            });
        }

        /** 編輯單字 */
        function editVocab(docId) {
            const vocab = vocabList.find(v => v.id === docId);
            if (!vocab) return;

            editingWord = vocab;
            
            document.getElementById('word').value = vocab.word;
            document.getElementById('meaning').value = vocab.meaning;
            document.getElementById('partOfSpeech').value = vocab.partOfSpeech;
            document.getElementById('context').value = vocab.context;

            document.getElementById('uploadForm').querySelector('button[type="submit"]').textContent = '更新單字';
            document.getElementById('uploadTab').querySelector('h2').textContent = `修改單字: ${vocab.word}`;

            openTab(null, 'uploadTab');
        }

        /** 刪除單字 (從 Firestore 刪除) */
        async function deleteVocab(docId) {
            if (confirm('確定要刪除這個單字嗎？此操作會從共享資料庫中永久移除！')) {
                try {
                    await window.vocabCollection.doc(docId).delete();
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    alert("刪除失敗！請檢查 Firebase 連線或權限。");
                }
            }
        }

        // ** 2. 抽考功能 (以下邏輯不變) **

        /** 初始化測驗設定並準備題目 */
        function startQuiz() {
            if (vocabList.length === 0) {
                alert('單字清單是空的，請先上傳單字，或等待資料庫載入完成！');
                return;
            }

            const count = parseInt(document.getElementById('quizCount').value);
            const rangeText = document.getElementById('quizRange').value.trim();
            
            hintLimit = parseInt(document.getElementById('hintLimit').value); 
            totalHintsUsed = 0; 

            quizSettings = {
                count: Math.min(count, vocabList.length), 
                range: rangeText ? rangeText.toLowerCase().split(',').map(s => s.trim()) : [],
                hintLimit: Math.min(Math.max(hintLimit, 1), 5) 
            };

            let filteredVocab = vocabList;
            if (quizSettings.range.length > 0 && quizSettings.range[0] !== "") {
                filteredVocab = vocabList.filter(vocab => {
                    return quizSettings.range.some(keyword => 
                        vocab.word.toLowerCase().includes(keyword) || 
                        vocab.meaning.includes(keyword)
                    );
                });
            }

            if (filteredVocab.length === 0) {
                alert('找不到符合範圍的單字，請修改抽考範圍！');
                return;
            }

            currentQuiz = [];
            const availableVocab = [...filteredVocab]; 
            for (let i = 0; i < quizSettings.count; i++) {
                const randomIndex = Math.floor(Math.random() * availableVocab.length);
                const selectedVocab = availableVocab.splice(randomIndex, 1)[0];
                const type = Math.floor(Math.random() * 2);
                currentQuiz.push({
                    ...selectedVocab,
                    type: type,
                    isCorrect: false,
                    hintsUsed: 0, 
                    studentInput: ''
                });
                if (availableVocab.length === 0) break;
            }

            currentQuestionIndex = 0;
            correctAnswers = 0;
            document.getElementById('quizArea').style.display = 'block';
            document.getElementById('quizResult').style.display = 'none';

            loadQuestion();
            openTab(null, 'quizSetupTab'); 
        }

        /** 載入當前題目 */
        function loadQuestion() {
            if (currentQuestionIndex >= currentQuiz.length) {
                endQuiz();
                return;
            }

            const currentQ = currentQuiz[currentQuestionIndex];

            document.getElementById('quizScore').textContent = `第 ${currentQuestionIndex + 1} 題 / 共 ${currentQuiz.length} 題`;
            document.getElementById('studentAnswer').value = '';
            document.getElementById('quizFeedback').style.display = 'none';
            document.getElementById('correctAnswer').style.display = 'none';
            document.getElementById('nextButton').style.display = 'none';
            document.getElementById('hintArea').textContent = '';
            document.getElementById('studentAnswer').disabled = false;
            document.querySelector('#quizArea button:nth-child(5)').disabled = false; 

            document.getElementById('hintRemaining').textContent = hintLimit - totalHintsUsed;
            if (totalHintsUsed >= hintLimit) {
                document.getElementById('hintButton').style.display = 'none';
            } else {
                document.getElementById('hintButton').style.display = 'inline-block';
            }

            let questionText = "";
            let quizType = "";
            if (currentQ.type === 0) { 
                quizType = "看英文寫中文意思";
                questionText = `${currentQ.word} (${currentQ.partOfSpeech}) 的中文意思是？`;
            } else { 
                quizType = "看中文意思寫英文單字";
                questionText = `「${currentQ.meaning}」的英文單字是？`;
            }
            document.getElementById('quizType').textContent = `[題型] ${quizType}`;
            document.getElementById('quizQuestion').textContent = questionText;
        }

        /** 顯示提示 */
        function showHint() {
            if (totalHintsUsed < hintLimit) {
                totalHintsUsed++;
                currentQuiz[currentQuestionIndex].hintsUsed++; 
                
                document.getElementById('hintArea').textContent = `情境提示：${currentQuiz[currentQuestionIndex].context}`;
                document.getElementById('hintRemaining').textContent = hintLimit - totalHintsUsed;
            }

            if (totalHintsUsed >= hintLimit) {
                document.getElementById('hintButton').style.display = 'none';
            }
        }

        /** 送出答案並批改 (邏輯不變) */
        function submitAnswer() {
            const studentAnswer = document.getElementById('studentAnswer').value.trim();
            const currentQ = currentQuiz[currentQuestionIndex];
            
            let isCorrect = false;
            let correctAnswerText = '';

            if (currentQ.type === 0) { 
                correctAnswerText = currentQ.meaning;
                isCorrect = correctAnswerText.toLowerCase().includes(studentAnswer.toLowerCase());
            } else { 
                correctAnswerText = currentQ.word;
                isCorrect = studentAnswer.toLowerCase() === correctAnswerText.toLowerCase();
            }

            const feedback = document.getElementById('quizFeedback');
            const correctDisplay = document.getElementById('theAnswer');
            
            feedback.style.display = 'block';
            document.getElementById('correctAnswer').style.display = 'block';
            document.getElementById('nextButton').style.display = 'inline-block';
            document.getElementById('hintButton').style.display = 'none';
            document.getElementById('studentAnswer').disabled = true;
            document.querySelector('#quizArea button:nth-child(5)').disabled = true; 
            
            correctDisplay.textContent = correctAnswerText;

            if (isCorrect && !currentQ.isCorrect) { 
                feedback.className = 'feedback correct';
                feedback.textContent = '✅ 正確！答對了！';
                correctAnswers++;
                currentQ.isCorrect = true; 
            } else if (isCorrect && currentQ.isCorrect) {
                feedback.className = 'feedback correct';
                feedback.textContent = '✅ 正確！';
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = '❌ 錯誤！請看正確答案，或點選下一題。';
            }

            currentQ.studentInput = studentAnswer;
        }

        /** 進入下一題 */
        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        /** 結束測驗 */
        function endQuiz() {
            document.getElementById('quizArea').style.display = 'none';
            const resultDisplay = document.getElementById('quizResult');
            resultDisplay.style.display = 'block';
            resultDisplay.innerHTML = `
                測驗結束！<br>
                總共 ${currentQuiz.length} 題，答對 ${correctAnswers} 題。<br>
                正確率：${((correctAnswers / currentQuiz.length) * 100).toFixed(1)}%
                <hr>
                <h4>測驗結果詳情：</h4>
            `;
            
            currentQuiz.forEach((q, index) => {
                const correctAnswer = q.type === 0 ? q.meaning : q.word;
                const questionPrompt = q.type === 0 ? q.word : q.meaning;
                const status = q.isCorrect ? '✅ 答對' : '❌ 答錯';
                const statusColor = q.isCorrect ? 'green' : 'red';
                resultDisplay.innerHTML += `
                    <p style="border-left: 4px solid ${statusColor}; padding-left: 10px;">
                        <strong>${index + 1}. ${questionPrompt}</strong> <span style="color: ${statusColor};">(${status})</span><br>
                        您的答案: ${q.studentInput || '未作答'} <br>
                        正確答案: ${correctAnswer} (${q.partOfSpeech})<br>
                        提示使用: ${q.hintsUsed} 次
                    </p>
                `;
            });
        }

        // ** 介面控制 **

        /** Tab 切換功能 */
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) {
                evt.currentTarget.className += " active";
            } else {
                document.querySelector(`.tab-button[onclick*="${tabName}"]`).className += " active";
            }

            if (tabName === 'uploadTab' && !editingWord) {
                resetUploadState();
            }
        }

        // 初始化：啟動即時資料庫監聽
        window.onload = function() {
            // 由於採用傳統 CDN 方式，我們知道初始化會先於此處執行
            startRealtimeListener();
            openTab(null, 'uploadTab'); 
        };
    </script>
