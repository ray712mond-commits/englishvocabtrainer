<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€æœ€çµ‚å®Œç¾ç‰ˆã€‘æˆ‘çš„è‹±æ–‡å–®å­—ç·´ç¿’æœ¬ - å…±äº«é›²ç«¯ç‰ˆ</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // =========================================================
        // æ‚¨çš„ Firebase å°ˆæ¡ˆè¨­å®š (å·²ç”± Gemini å¡«å…¥)
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbmwpXx0mnZDd5xOcc2qlc3BkrE7_VFVw",
            authDomain: "englishvocabtrainer-b1de4.firebaseapp.com",
            projectId: "englishvocabtrainer-b1de4",
            storageBucket: "englishvocabtrainer-b1de4.firebasestorage.app",
            messagingSenderId: "415372743931",
            appId: "1:415372743931:web:3a734463227111d5704c5e"
        };

        // åˆå§‹åŒ– Firebase App å’Œ Firestore
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore(); 
        
        window.db = db;
        window.vocabCollection = db.collection("vocabWords");
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; text-align: center; margin-bottom: 30px; }
        .tab-menu { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-button { 
            padding: 12px 20px; 
            cursor: pointer; 
            border: none; 
            background-color: #eee; 
            margin-right: 5px; 
            border-radius: 8px 8px 0 0; 
            font-weight: bold; 
            transition: background-color 0.3s;
        }
        .tab-button.active { 
            background-color: #007bff; 
            color: white; 
            border-bottom: 2px solid #007bff; 
        }
        /* é–å®šæŒ‰éˆ•çš„æ¨£å¼ */
        .tab-button.locked {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; transition: border-color 0.3s; }
        button { background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        button:hover:not(:disabled) { background-color: #218838; }
        
        /* è€ƒå·æ¨£å¼ */
        #quizArea { 
            border: 1px dashed #007bff; 
            padding: 20px; 
            border-radius: 8px; 
            margin-top: 20px;
        }
        .quiz-question-item {
            border-bottom: 1px dashed #ccc;
            padding: 15px 0;
            margin-bottom: 15px;
        }
        .quiz-question-item:last-child {
            border-bottom: none;
        }
        .question-prompt {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .quiz-answer-input {
            width: calc(100% - 130px);
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .hint-button {
            background-color: #ffc107;
            color: #333;
            padding: 8px 10px;
            font-size: 14px;
            vertical-align: top;
        }
        .hint-button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
        }
        .hint-text {
            margin-top: 8px;
            font-style: italic;
            color: #777;
            padding: 5px;
            border-left: 3px solid #ffc107;
            display: none;
        }
        .result-reveal {
            margin-top: 5px;
            padding: 5px;
            border-radius: 4px;
            font-weight: bold;
        }
        .result-correct { background-color: #d4edda; color: #155724; }
        .result-incorrect { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="container">
    <h1>ã€å…±äº«ç‰ˆã€‘æˆ‘çš„è‹±æ–‡å–®å­—ç·´ç¿’æœ¬</h1>
    <p style="text-align: center; color: red; font-weight: bold;">å–®å­—è³‡æ–™å·²åŒæ­¥è‡³å…±äº«é›²ç«¯è³‡æ–™åº«ï¼</p>

    <div class="tab-menu" id="tabMenu">
        <button class="tab-button active" id="uploadBtn" onclick="openTab(event, 'uploadTab')">ä¸Šå‚³æ–°å–®å­—</button>
        <button class="tab-button" id="quizSetupBtn" onclick="openTab(event, 'quizSetupTab')">é–‹å§‹æŠ½è€ƒ</button>
        <button class="tab-button" id="listBtn" onclick="openTab(event, 'listTab')">å–®å­—æ¸…å–® (å…±äº«)</button>
    </div>

    <div id="uploadTab" class="tab-content active">
        <h2>ä¸Šå‚³æ–°å–®å­—</h2>
        <form id="uploadForm">
            <div class="form-group">
                <label for="word">å–®å­— (è‹±æ–‡):</label>
                <input type="text" id="word" required>
            </div>
            <div class="form-group">
                <label for="meaning">ä¸­æ–‡æ„æ€:</label>
                <input type="text" id="meaning" required>
            </div>
            <div class="form-group">
                <label for="partOfSpeech">è©æ€§:</label>
                <select id="partOfSpeech" required>
                    <option value="">--è«‹é¸æ“‡--</option>
                    <option value="n">åè© (n.)</option>
                    <option value="v">å‹•è© (v.)</option>
                    <option value="adj">å½¢å®¹è© (adj.)</option>
                    <option value="adv">å‰¯è© (adv.)</option>
                    <option value="prep">ä»‹ç³»è© (prep.)</option>
                    <option value="conj">é€£æ¥è© (conj.)</option>
                    <option value="phr">ç‰‡èª (phr.)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="context">çœ‹åˆ°å–®å­—çš„åœ°æ–¹/æƒ…æ³ (ä½œç‚ºæç¤ºç”¨):</label>
                <textarea id="context" required></textarea>
            </div>
            <button type="submit">å„²å­˜å–®å­—</button>
            <p id="uploadMessage" style="color: green; margin-top: 10px; display: none;"></p>
        </form>
    </div>

    <div id="quizSetupTab" class="tab-content">
        <h2>æŠ½è€ƒè¨­å®š</h2>
        <div class="form-group">
            <label for="quizCount">æŠ½è€ƒé¡Œæ•¸:</label>
            <input type="number" id="quizCount" value="10" min="1" max="50">
        </div>
        <div class="form-group">
            <label for="quizRange">æŠ½è€ƒç¯„åœ (å¯é¸ï¼Œç•™ç©ºç‚ºå…¨éƒ¨å–®å­—):</label>
            <input type="text" id="quizRange" placeholder="è¼¸å…¥éƒ¨åˆ†ä¸­æ–‡æ„æ€æˆ–è‹±æ–‡å–®å­—ï¼Œä»¥é€—è™Ÿåˆ†éš”">
        </div>
        <div class="form-group">
            <label for="hintLimit">æç¤ºæ¬¡æ•¸ä¸Šé™ (0~5):</label>
            <input type="number" id="hintLimit" value="3" min="0" max="5">
        </div>
        <button onclick="startQuiz()">é–‹å§‹æ¸¬é©—</button>
    </div>

    <div id="quizArea" class="tab-content">
        <h3>å–®å­—æ¸¬é©— - <span id="hintStatus">å‰©é¤˜æç¤ºæ¬¡æ•¸ï¼š3</span></h3>
        <p>è«‹åœ¨æ‰€æœ‰é¡Œç›®ä¸Šä½œç­”å®Œç•¢å¾Œï¼Œé»æ“Šæœ€ä¸‹æ–¹çš„ã€Œæäº¤è€ƒå·ã€æŒ‰éˆ•ã€‚</p>
        
        <div id="quizFormContainer">
            </div>

        <div id="quizActionButtons" style="text-align: center; margin-top: 30px;">
            <button onclick="submitQuiz()" style="background-color: #007bff; padding: 15px 30px;">æäº¤è€ƒå·ä¸¦æ‰¹æ”¹</button>
        </div>
        
        <div id="quizResult" style="margin-top: 20px; font-size: 20px; font-weight: bold; display: none;"></div>
        <button id="restartButton" onclick="resetQuiz()" style="display: none; margin-top: 20px; background-color: #dc3545;">è¿”å›è¨­å®šé é¢</button>
    </div>


    <div id="listTab" class="tab-content">
        <h2>å·²ä¸Šå‚³å–®å­—æ¸…å–® (å…±äº«)</h2>
        <p>ç›®å‰ç¸½è¨ˆï¼š<span id="vocabCount">0</span> å€‹å–®å­—</p>
        <table id="vocabTable" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
            <thead>
                <tr>
                    <th>å–®å­— (è©æ€§)</th>
                    <th>ä¸­æ–‡æ„æ€</th>
                    <th>æƒ…å¢ƒ (æç¤º)</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<script>
    // ** å…¨åŸŸè®Šæ•¸ **
    let vocabList = [];
    let currentQuiz = []; 
    let editingWord = null; 
    let isQuizActive = false; 

    let totalHintsUsed = 0; 
    let hintLimit = 3; 

    // ** è³‡æ–™å„²å­˜ (ä½¿ç”¨ Firebase Firestore) **
    
    /** å•Ÿå‹•å³æ™‚ç›£è½ï¼Œå¾ Firestore è®€å–æ‰€æœ‰å–®å­—ä¸¦æ›´æ–°å…¨åŸŸè®Šæ•¸ */
    function startRealtimeListener() {
        if (!window.db || !window.vocabCollection) {
            console.error("Firebase å‡½å¼åº«æœªè¼‰å…¥ï¼è«‹æª¢æŸ¥ CDN è…³æœ¬æ˜¯å¦æ­£ç¢ºã€‚");
            document.getElementById('vocabCount').textContent = 'è¼‰å…¥å¤±æ•— (Firebase éŒ¯èª¤)';
            return;
        }

        window.vocabCollection.onSnapshot((snapshot) => {
            vocabList = [];
            snapshot.forEach((doc) => {
                vocabList.push({ id: doc.id, ...doc.data() });
            });
            vocabList.sort((a, b) => a.word.localeCompare(b.word));
            
            renderVocabList(); 
        }, (error) => {
            console.error("Error listening to Firestore: ", error);
            document.getElementById('vocabCount').textContent = 'è¼‰å…¥å¤±æ•—';
        });
    }

    // ** 1. ä¸Šå‚³/æ›´æ–°å–®å­—åŠŸèƒ½ (å¯«å…¥ Firestore) **

    function setupFormListener() {
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            
            const newWordData = {
                word: document.getElementById('word').value.trim(),
                meaning: document.getElementById('meaning').value.trim(),
                partOfSpeech: document.getElementById('partOfSpeech').value,
                context: document.getElementById('context').value.trim(),
            };

            const msg = document.getElementById('uploadMessage');

            try {
                if (editingWord) {
                    await window.vocabCollection.doc(editingWord.id).update(newWordData);
                    msg.textContent = `æˆåŠŸæ›´æ–°å–®å­—: ${newWordData.word}`;
                } else {
                    const existing = vocabList.find(v => v.word.toLowerCase() === newWordData.word.toLowerCase());
                    if (existing) {
                        alert(`å–®å­— "${newWordData.word}" å·²ç¶“å­˜åœ¨æ–¼æ¸…å–®ä¸­ï¼`);
                        submitButton.disabled = false;
                        return;
                    }

                    await window.vocabCollection.add({ 
                        ...newWordData, 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                    msg.textContent = `æˆåŠŸå„²å­˜å–®å­—: ${newWordData.word} (å·²åŒæ­¥åˆ°é›²ç«¯)`;
                }

                document.getElementById('uploadForm').reset();
                resetUploadState(); 
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
                
            } catch (error) {
                console.error("Error saving document: ", error);
                alert("å„²å­˜/æ›´æ–°å¤±æ•—ï¼è«‹æª¢æŸ¥ Firebase æ¬Šé™æˆ–ç¶²è·¯é€£ç·šã€‚");
            } finally {
                submitButton.disabled = false;
            }
        });
    }

    /** é‡è¨­ä¸Šå‚³è¡¨å–®çš„ç‹€æ…‹ */
    function resetUploadState() {
        editingWord = null;
        document.getElementById('uploadForm').querySelector('button[type="submit"]').textContent = 'å„²å­˜å–®å­—';
        document.getElementById('uploadTab').querySelector('h2').textContent = 'ä¸Šå‚³æ–°å–®å­—';
    }


    // ** 3. å–®å­—æ¸…å–®é¡¯ç¤º/æ“ä½œ **

    function renderVocabList() {
        const tbody = document.getElementById('vocabTable').querySelector('tbody');
        tbody.innerHTML = '';
        document.getElementById('vocabCount').textContent = vocabList.length;

        vocabList.forEach(vocab => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${vocab.word} (${vocab.partOfSpeech})</td>
                <td>${vocab.meaning}</td>
                <td>${vocab.context}</td>
                <td>
                    <button style="background-color: #007bff; margin-right: 5px;" onclick="editVocab('${vocab.id}')">ä¿®æ”¹</button>
                    <button style="background-color: #dc3545;" onclick="deleteVocab('${vocab.id}')">åˆªé™¤</button>
                </td>
            `;
        });
    }

    function editVocab(docId) {
        const vocab = vocabList.find(v => v.id === docId);
        if (!vocab) return;

        editingWord = vocab;
        
        document.getElementById('word').value = vocab.word;
        document.getElementById('meaning').value = vocab.meaning;
        document.getElementById('partOfSpeech').value = vocab.partOfSpeech;
        document.getElementById('context').value = vocab.context;

        document.getElementById('uploadForm').querySelector('button[type="submit"]').textContent = 'æ›´æ–°å–®å­—';
        document.getElementById('uploadTab').querySelector('h2').textContent = `ä¿®æ”¹å–®å­—: ${vocab.word}`;

        openTab(null, 'uploadTab');
    }

    async function deleteVocab(docId) {
        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å–®å­—å—ï¼Ÿæ­¤æ“ä½œæœƒå¾å…±äº«è³‡æ–™åº«ä¸­æ°¸ä¹…ç§»é™¤ï¼')) {
            try {
                await window.vocabCollection.doc(docId).delete();
            } catch (error) {
                console.error("Error deleting document: ", error);
                alert("åˆªé™¤å¤±æ•—ï¼è«‹æª¢æŸ¥ Firebase é€£ç·šæˆ–æ¬Šé™ã€‚");
            }
        }
    }

    // ** 2. æŠ½è€ƒåŠŸèƒ½ - æ ¸å¿ƒé‡å¯«ç‚ºè€ƒå·æ¨¡å¼ **

    /** é–‹å§‹æ¸¬é©—ï¼šç”Ÿæˆæ‰€æœ‰é¡Œç›®ä¸¦é–å®šé é¢ */
    function startQuiz() {
        if (vocabList.length === 0) {
            alert('å–®å­—æ¸…å–®æ˜¯ç©ºçš„ï¼Œè«‹å…ˆä¸Šå‚³å–®å­—ï¼');
            return;
        }

        const count = parseInt(document.getElementById('quizCount').value);
        const rangeText = document.getElementById('quizRange').value.trim();
        const hintLimitInput = parseInt(document.getElementById('hintLimit').value);
        
        // è¨­å®šå…¨åŸŸæç¤ºé™åˆ¶
        hintLimit = Math.min(Math.max(hintLimitInput, 0), 5); // å…è¨± 0 å€‹æç¤º
        totalHintsUsed = 0; // é‡ç½®å·²ä½¿ç”¨æ¬¡æ•¸

        // ç¯©é¸ç¯„åœé‚è¼¯ (ä¸è®Š)
        let filteredVocab = vocabList;
        if (rangeText) {
            const keywords = rangeText.toLowerCase().split(',').map(s => s.trim());
            filteredVocab = vocabList.filter(vocab => {
                return keywords.some(keyword => 
                    vocab.word.toLowerCase().includes(keyword) || 
                    vocab.meaning.includes(keyword)
                );
            });
        }

        if (filteredVocab.length === 0) {
            alert('æ‰¾ä¸åˆ°ç¬¦åˆç¯„åœçš„å–®å­—ï¼Œè«‹ä¿®æ”¹æŠ½è€ƒç¯„åœï¼');
            return;
        }
        
        // éš¨æ©ŸæŠ½é¸é¡Œç›®
        currentQuiz = [];
        const availableVocab = [...filteredVocab]; 
        const actualCount = Math.min(count, filteredVocab.length);
        
        for (let i = 0; i < actualCount; i++) {
            const randomIndex = Math.floor(Math.random() * availableVocab.length);
            const selectedVocab = availableVocab.splice(randomIndex, 1)[0];
            const type = Math.floor(Math.random() * 2); // 0=è‹±ç¿»ä¸­, 1=ä¸­ç¿»è‹±
            
            currentQuiz.push({
                ...selectedVocab,
                type: type, 
                id: selectedVocab.id,
                isAnswered: false,
                isCorrect: false,
                studentInput: '',
                hintUsed: false, 
                questionIndex: i + 1
            });
        }

        // æ¸²æŸ“è€ƒå·
        renderQuizForm();
        // é–å®šåˆ†é ä¸¦åˆ‡æ›åˆ°æ¸¬é©—é é¢
        lockTabs();
        openTab(null, 'quizArea');
        isQuizActive = true;
    }

    /** æ¸²æŸ“æ‰€æœ‰é¡Œç›®åˆ°è€ƒå·å®¹å™¨ */
    function renderQuizForm() {
        const container = document.getElementById('quizFormContainer');
        const hintStatus = document.getElementById('hintStatus');
        container.innerHTML = '';
        
        hintStatus.textContent = `å‰©é¤˜æç¤ºæ¬¡æ•¸ï¼š${hintLimit - totalHintsUsed}`;
        document.getElementById('quizResult').style.display = 'none';
        document.getElementById('restartButton').style.display = 'none';
        document.getElementById('quizActionButtons').style.display = 'block';

        currentQuiz.forEach((q) => {
            const prompt = q.type === 0 
                ? `${q.word} (${q.partOfSpeech}) çš„ä¸­æ–‡æ„æ€æ˜¯ï¼Ÿ` // è‹±ç¿»ä¸­
                : `ã€Œ${q.meaning}ã€çš„è‹±æ–‡å–®å­—æ˜¯ï¼Ÿ`; // ä¸­ç¿»è‹±
            
            const isHintDisabled = totalHintsUsed >= hintLimit;
            const remainingHints = hintLimit - totalHintsUsed;

            const itemHtml = `
                <div class="quiz-question-item" data-id="${q.id}" data-index="${q.questionIndex}">
                    <div class="question-prompt">
                        ${q.questionIndex}. ${prompt}
                    </div>
                    <div>
                        <input type="text" class="quiz-answer-input" id="answer-${q.id}" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ" autocomplete="off">
                        <button class="hint-button" id="hint-btn-${q.id}" onclick="showHint(this, '${q.id}')" ${isHintDisabled ? 'disabled' : ''}>
                            æç¤º (å‰©é¤˜ ${remainingHints})
                        </button>
                    </div>
                    <div id="hint-text-${q.id}" class="hint-text">æƒ…å¢ƒæç¤ºï¼š${q.context}</div>
                    <div id="result-text-${q.id}" class="result-reveal" style="display:none;"></div>
                </div>
            `;
            container.innerHTML += itemHtml;
        });
    }

    /** é¡¯ç¤ºæç¤º (ç¨ç«‹åˆ°æ¯é¡Œï¼Œä½†å…±ç”¨é…é¡) */
    function showHint(button, docId) {
        
        const question = currentQuiz.find(q => q.id === docId);
        if (!question) return;

        if (totalHintsUsed >= hintLimit) {
            button.disabled = true;
            return;
        }

        // åªæœ‰åœ¨è©²é¡Œé‚„æ²’ç”¨éæç¤ºæ™‚ï¼Œæ‰æ‰£é™¤é…é¡
        if (!question.hintUsed) {
            totalHintsUsed++; // ç¸½æç¤ºæ¬¡æ•¸ -1
            question.hintUsed = true;
        }

        // æ›´æ–° UI
        const remainingHints = hintLimit - totalHintsUsed;
        document.getElementById('hintStatus').textContent = `å‰©é¤˜æç¤ºæ¬¡æ•¸ï¼š${remainingHints}`;
        document.getElementById(`hint-text-${docId}`).style.display = 'block';
        button.disabled = true; // è©²é¡ŒæŒ‰éˆ•ç¦ç”¨

        // æ›´æ–°æ‰€æœ‰æç¤ºæŒ‰éˆ•çš„å‰©é¤˜æ¬¡æ•¸é¡¯ç¤ºå’Œç¦ç”¨ç‹€æ…‹
        document.querySelectorAll('.hint-button').forEach(btn => {
            btn.textContent = `æç¤º (å‰©é¤˜ ${remainingHints})`;
            if (remainingHints <= 0) {
                 btn.disabled = true;
            }
        });
    }

    /** æäº¤è€ƒå·ä¸¦æ‰¹æ”¹ */
    function submitQuiz() {
        let correctCount = 0;
        
        // 1. å„²å­˜ç­”æ¡ˆ
        currentQuiz.forEach(q => {
            const inputElement = document.getElementById(`answer-${q.id}`);
            q.studentInput = inputElement.value.trim();
        });

        // 2. æ‰¹æ”¹ä¸¦é¡¯ç¤ºçµæœ
        currentQuiz.forEach(q => {
            const resultElement = document.getElementById(`result-text-${q.id}`);
            const inputElement = document.getElementById(`answer-${q.id}`);
            const hintButton = document.getElementById(`hint-btn-${q.id}`);

            let correctAnswer = q.type === 0 ? q.meaning : q.word;
            // ç°¡åŒ–æ‰¹æ”¹é‚è¼¯ï¼šè‹±ç¿»ä¸­(åŒ…å«å³å¯)ï¼Œä¸­ç¿»è‹±(å®Œå…¨åŒ¹é…)
            let isCorrect = q.type === 0
                ? correctAnswer.toLowerCase().includes(q.studentInput.toLowerCase())
                : q.studentInput.toLowerCase() === correctAnswer.toLowerCase();
            
            q.isCorrect = isCorrect;
            
            // ç¦ç”¨è¼¸å…¥æ¡†å’Œæç¤ºæŒ‰éˆ•
            inputElement.disabled = true;
            if (hintButton) hintButton.disabled = true;

            // é¡¯ç¤ºæ‰¹æ”¹çµæœ
            resultElement.style.display = 'block';
            if (isCorrect) {
                correctCount++;
                resultElement.className = 'result-reveal result-correct';
                resultElement.innerHTML = `âœ… **æ­£ç¢ºï¼**`;
            } else {
                resultElement.className = 'result-reveal result-incorrect';
                resultElement.innerHTML = `âŒ **éŒ¯èª¤ï¼** æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correctAnswer} (${q.type === 0 ? 'ä¸­æ–‡' : 'è‹±æ–‡'})`;
            }
        });

        // 3. é¡¯ç¤ºç¸½æˆç¸¾
        const total = currentQuiz.length;
        document.getElementById('quizActionButtons').style.display = 'none';
        document.getElementById('hintStatus').textContent = `æ¸¬é©—å·²å®Œæˆã€‚å…±ä½¿ç”¨ ${totalHintsUsed} æ¬¡æç¤ºã€‚`;
        
        const resultDisplay = document.getElementById('quizResult');
        resultDisplay.style.display = 'block';
        resultDisplay.innerHTML = `
            ğŸ‰ æ¸¬é©—çµæœï¼š<br>
            ç¸½å…± ${total} é¡Œï¼Œç­”å° **${correctCount}** é¡Œã€‚<br>
            æ­£ç¢ºç‡ï¼š**${((correctCount / total) * 100).toFixed(1)}%**
        `;

        // é¡¯ç¤ºè¿”å›æŒ‰éˆ•
        document.getElementById('restartButton').style.display = 'inline-block';
        isQuizActive = false;
        unlockTabs();
    }

    /** é‡ç½®æ¸¬é©—ç‹€æ…‹ä¸¦è¿”å›è¨­å®šé é¢ */
    function resetQuiz() {
        currentQuiz = [];
        totalHintsUsed = 0;
        hintLimit = 3;
        isQuizActive = false;
        unlockTabs();
        openTab(null, 'quizSetupTab');
        document.getElementById('quizArea').style.display = 'none';
    }


    // ** ä»‹é¢æ§åˆ¶ **

    /** é–å®šæ‰€æœ‰éæ¸¬é©—ç›¸é—œçš„ Tab */
    function lockTabs() {
        const buttons = document.querySelectorAll('#tabMenu .tab-button');
        buttons.forEach(button => {
            if (button.id !== 'quizSetupBtn' && button.id !== 'quizArea') {
                 button.classList.add('locked');
                 button.disabled = true;
            } else {
                button.disabled = false;
            }
        });
    }

    /** è§£é–æ‰€æœ‰ Tab */
    function unlockTabs() {
        const buttons = document.querySelectorAll('#tabMenu .tab-button');
        buttons.forEach(button => {
             button.classList.remove('locked');
             button.disabled = false;
        });
    }


    /** Tab åˆ‡æ›åŠŸèƒ½ */
    function openTab(evt, tabName) {
        // å¦‚æœæ¸¬é©—é€²è¡Œä¸­ï¼Œä¸”å˜—è©¦åˆ‡æ›åˆ°éæ¸¬é©—é é¢ï¼Œå‰‡é˜»æ­¢ (è§£æ±ºä½œå¼Šå•é¡Œ)
        if (isQuizActive && tabName !== 'quizArea' && tabName !== 'quizSetupTab') {
            alert('æ¸¬é©—æ­£åœ¨é€²è¡Œä¸­ï¼Œè«‹å…ˆå®Œæˆè€ƒå·ï¼');
            return;
        }
        
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            // åªæœ‰åœ¨éé–å®šç‹€æ…‹ä¸‹æ‰ç§»é™¤ active class
            if (!tablinks[i].classList.contains('locked')) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
        }
        document.getElementById(tabName).style.display = "block";
        
        if (evt) {
            evt.currentTarget.className += " active";
        } else {
            const targetButton = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
            if (targetButton) {
                targetButton.className += " active";
            }
        }

        if (tabName === 'uploadTab' && !editingWord) {
            resetUploadState();
        }
    }

    // ç¢ºä¿åœ¨æ‰€æœ‰ DOM å…ƒç´ è¼‰å…¥å¾Œæ‰åŸ·è¡Œç¨‹å¼ç¢¼
    window.onload = function() {
        setupFormListener();
        startRealtimeListener();
        openTab(null, 'uploadTab'); 
    };
</script>

</body>
</html>
