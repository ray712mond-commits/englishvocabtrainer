<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebase/9/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebase/9/firebase-firestore.js";

        // =========================================================
        // !!! 🚨 這裡需要貼上您從 Firebase 專案複製的設定資訊 !!!
        // 請確認您的金鑰已經貼在這裡，不要再保留 YOUR_FIREBASE_CONFIG_...
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbmwpXx0mnZDd5xOcc2qlc3BkrE7_VFVw", // <-- 替換成您的實際金鑰
            authDomain: "englishvocabtrainer-b1de4.firebaseapp.com", // <-- 替換成您的實際網域
            projectId: "englishvocabtrainer-b1de4", // <-- 替換成您的實際專案 ID
            storageBucket: "englishvocabtrainer-b1de4.firebasestorage.app",
            messagingSenderId: "415372743931",
            appId: "1:415372743931:web:3a734463227111d5704c5e"
        };
        // =========================================================

        // 初始化 Firebase App 和 Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const vocabCollection = collection(db, "vocabWords");

        // 導出所有需要的 Firebase 函式
        window.firebaseUtils = {
            db, vocabCollection, onSnapshot, doc, deleteDoc, addDoc, updateDoc, serverTimestamp
        };
    </script>

    <script>
        // ** 全域變數 **
        let vocabList = [];
        let currentQuiz = []; 
        let currentQuestionIndex = 0;
        let quizSettings = {};
        let correctAnswers = 0;

        // 問題 3 修正：提示次數改為全域追蹤，不隨題目重置
        let totalHintsUsed = 0; 
        let hintLimit = 3; // 預設值

        // 問題 4 修正：用於追蹤當前正在編輯的單字 (如果為 null 則表示新增)
        let editingWord = null; 

        // ** 資料儲存 (使用 Firebase Firestore) **
        
        /** 啟動即時監聽，從 Firestore 讀取所有單字並更新全域變數 */
        function startRealtimeListener() {
            if (!window.firebaseUtils) {
                console.error("Firebase 函式庫未載入！");
                document.getElementById('vocabCount').textContent = '載入失敗 (Firebase 錯誤)';
                return;
            }
            const { vocabCollection, onSnapshot } = window.firebaseUtils;

            // Firestore 監聽：按單字字母排序，方便查找
            onSnapshot(vocabCollection, (snapshot) => {
                vocabList = [];
                snapshot.forEach((doc) => {
                    vocabList.push({ id: doc.id, ...doc.data() });
                });
                // 讓單字清單按英文單字字母排序，方便查找
                vocabList.sort((a, b) => a.word.localeCompare(b.word));
                
                // 資料更新後，立即重新渲染列表
                renderVocabList(); 
            }, (error) => {
                console.error("Error listening to Firestore: ", error);
                document.getElementById('vocabCount').textContent = '載入失敗';
            });
        }

        // ** 1. 上傳/更新單字功能 (寫入 Firestore) **

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true; // 問題 1 修正：防止重複點擊
            
            const { vocabCollection, addDoc, doc, updateDoc, serverTimestamp } = window.firebaseUtils;

            const newWordData = {
                word: document.getElementById('word').value.trim(),
                meaning: document.getElementById('meaning').value.trim(),
                partOfSpeech: document.getElementById('partOfSpeech').value,
                context: document.getElementById('context').value.trim(),
            };

            const msg = document.getElementById('uploadMessage');

            try {
                if (editingWord) {
                    // 問題 4 修正：這是修改現有單字
                    const wordRef = doc(vocabCollection, editingWord.id);
                    await updateDoc(wordRef, newWordData);
                    msg.textContent = `成功更新單字: ${newWordData.word}`;
                } else {
                    // 這是新增單字
                    
                    // 檢查單字是否已經存在 (簡化檢查)
                    const existing = vocabList.find(v => v.word.toLowerCase() === newWordData.word.toLowerCase());
                    if (existing) {
                        alert(`單字 "${newWordData.word}" 已經存在於清單中！`);
                        submitButton.disabled = false; // 恢復按鈕
                        return;
                    }

                    await addDoc(vocabCollection, { ...newWordData, timestamp: serverTimestamp() });
                    msg.textContent = `成功儲存單字: ${newWordData.word} (已同步到雲端)`;
                }

                // 清理狀態
                document.getElementById('uploadForm').reset();
                resetUploadState(); 
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
                
            } catch (error) {
                console.error("Error saving document: ", error);
                alert("儲存/更新失敗！請檢查 Firebase 設定或網路連線。");
            } finally {
                submitButton.disabled = false; // 問題 1 修正：不論成功失敗，都要恢復按鈕
            }
        });

        /** 重設上傳表單的狀態 */
        function resetUploadState() {
            editingWord = null;
            document.getElementById('uploadForm').querySelector('button[type="submit"]').textContent = '儲存單字';
            document.getElementById('uploadTab').querySelector('h2').textContent = '上傳新單字';
        }


        // ** 3. 單字清單顯示/操作 **

        /** 渲染單字清單表格 */
        function renderVocabList() {
            const tbody = document.getElementById('vocabTable').querySelector('tbody');
            tbody.innerHTML = '';
            document.getElementById('vocabCount').textContent = vocabList.length;

            vocabList.forEach(vocab => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${vocab.word} (${vocab.partOfSpeech})</td>
                    <td>${vocab.meaning}</td>
                    <td>${vocab.context}</td>
                    <td>
                        <button style="background-color: #007bff; margin-right: 5px;" onclick="editVocab('${vocab.id}')">修改</button>
                        <button style="background-color: #dc3545;" onclick="deleteVocab('${vocab.id}')">刪除</button>
                    </td>
                `;
            });
        }

        /** 編輯單字 (問題 4 修正：新增功能) */
        function editVocab(docId) {
            const vocab = vocabList.find(v => v.id === docId);
            if (!vocab) return;

            editingWord = vocab;
            
            // 載入資料到表單
            document.getElementById('word').value = vocab.word;
            document.getElementById('meaning').value = vocab.meaning;
            document.getElementById('partOfSpeech').value = vocab.partOfSpeech;
            document.getElementById('context').value = vocab.context;

            // 更改按鈕和標題文字
            document.getElementById('uploadForm').querySelector('button[type="submit"]').textContent = '更新單字';
            document.getElementById('uploadTab').querySelector('h2').textContent = `修改單字: ${vocab.word}`;

            // 切換到上傳分頁
            openTab(null, 'uploadTab');
        }

        /** 刪除單字 (從 Firestore 刪除) */
        async function deleteVocab(docId) {
            const { db, doc, deleteDoc } = window.firebaseUtils;
            
            if (confirm('確定要刪除這個單字嗎？此操作會從共享資料庫中永久移除！')) {
                try {
                    await deleteDoc(doc(db, "vocabWords", docId));
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    alert("刪除失敗！請檢查 Firebase 連線或權限。");
                }
            }
        }

        // ** 2. 抽考功能 **

        /** 初始化測驗設定並準備題目 */
        function startQuiz() {
            // 問題 2 修正：檢查單字是否已載入
            if (vocabList.length === 0) {
                alert('單字清單是空的，請先上傳單字，或等待資料庫載入完成！');
                return;
            }

            // 讀取設定
            const count = parseInt(document.getElementById('quizCount').value);
            const rangeText = document.getElementById('quizRange').value.trim();
            
            // 問題 3 修正：全域設定提示次數
            hintLimit = parseInt(document.getElementById('hintLimit').value); 
            totalHintsUsed = 0; // 問題 3 修正：重置全域提示計數

            quizSettings = {
                count: Math.min(count, vocabList.length), 
                range: rangeText ? rangeText.toLowerCase().split(',').map(s => s.trim()) : [],
                hintLimit: Math.min(Math.max(hintLimit, 1), 5) 
            };

            // ... (以下篩選和抽選邏輯不變)

            let filteredVocab = vocabList;
            if (quizSettings.range.length > 0 && quizSettings.range[0] !== "") {
                filteredVocab = vocabList.filter(vocab => {
                    return quizSettings.range.some(keyword => 
                        vocab.word.toLowerCase().includes(keyword) || 
                        vocab.meaning.includes(keyword)
                    );
                });
            }

            if (filteredVocab.length === 0) {
                alert('找不到符合範圍的單字，請修改抽考範圍！');
                return;
            }

            currentQuiz = [];
            const availableVocab = [...filteredVocab]; 
            for (let i = 0; i < quizSettings.count; i++) {
                const randomIndex = Math.floor(Math.random() * availableVocab.length);
                const selectedVocab = availableVocab.splice(randomIndex, 1)[0];
                const type = Math.floor(Math.random() * 2);
                currentQuiz.push({
                    ...selectedVocab,
                    type: type,
                    isCorrect: false,
                    hintsUsed: 0, 
                    studentInput: ''
                });
                if (availableVocab.length === 0) break;
            }

            // 重置測驗狀態
            currentQuestionIndex = 0;
            correctAnswers = 0;
            document.getElementById('quizArea').style.display = 'block';
            document.getElementById('quizResult').style.display = 'none';

            loadQuestion();
            openTab(null, 'quizSetupTab'); 
        }

        /** 載入當前題目 */
        function loadQuestion() {
            if (currentQuestionIndex >= currentQuiz.length) {
                endQuiz();
                return;
            }

            const currentQ = currentQuiz[currentQuestionIndex];

            // 重置介面
            document.getElementById('quizScore').textContent = `第 ${currentQuestionIndex + 1} 題 / 共 ${currentQuiz.length} 題`;
            document.getElementById('studentAnswer').value = '';
            document.getElementById('quizFeedback').style.display = 'none';
            document.getElementById('correctAnswer').style.display = 'none';
            document.getElementById('nextButton').style.display = 'none';
            document.getElementById('hintArea').textContent = '';
            document.getElementById('studentAnswer').disabled = false;
            document.querySelector('#quizArea button:nth-child(5)').disabled = false; 

            // 問題 3 修正：根據全域提示次數決定按鈕狀態
            document.getElementById('hintRemaining').textContent = hintLimit - totalHintsUsed;
            if (totalHintsUsed >= hintLimit) {
                document.getElementById('hintButton').style.display = 'none';
            } else {
                document.getElementById('hintButton').style.display = 'inline-block';
            }

            // 設置問題 (問題 2 修正：確保題目能顯示)
            let questionText = "";
            let quizType = "";
            if (currentQ.type === 0) { 
                quizType = "看英文寫中文意思";
                questionText = `${currentQ.word} (${currentQ.partOfSpeech}) 的中文意思是？`;
            } else { 
                quizType = "看中文意思寫英文單字";
                questionText = `「${currentQ.meaning}」的英文單字是？`;
            }
            document.getElementById('quizType').textContent = `[題型] ${quizType}`;
            document.getElementById('quizQuestion').textContent = questionText;
        }

        /** 顯示提示 (問題 3 修正：扣除全域提示次數) */
        function showHint() {
            if (totalHintsUsed < hintLimit) {
                totalHintsUsed++;
                currentQuiz[currentQuestionIndex].hintsUsed++; 
                
                document.getElementById('hintArea').textContent = `情境提示：${currentQuiz[currentQuestionIndex].context}`;
                document.getElementById('hintRemaining').textContent = hintLimit - totalHintsUsed;
            }

            if (totalHintsUsed >= hintLimit) {
                document.getElementById('hintButton').style.display = 'none';
            }
        }

        /** 送出答案並批改 */
        function submitAnswer() {
            const studentAnswer = document.getElementById('studentAnswer').value.trim();
            const currentQ = currentQuiz[currentQuestionIndex];
            
            let isCorrect = false;
            let correctAnswerText = '';

            if (currentQ.type === 0) { 
                correctAnswerText = currentQ.meaning;
                isCorrect = correctAnswerText.toLowerCase().includes(studentAnswer.toLowerCase());
            } else { 
                correctAnswerText = currentQ.word;
                isCorrect = studentAnswer.toLowerCase() === correctAnswerText.toLowerCase();
            }

            const feedback = document.getElementById('quizFeedback');
            const correctDisplay = document.getElementById('theAnswer');
            
            feedback.style.display = 'block';
            document.getElementById('correctAnswer').style.display = 'block';
            document.getElementById('nextButton').style.display = 'inline-block';
            document.getElementById('hintButton').style.display = 'none';
            document.getElementById('studentAnswer').disabled = true;
            document.querySelector('#quizArea button:nth-child(5)').disabled = true; 
            
            correctDisplay.textContent = correctAnswerText;

            if (isCorrect && !currentQ.isCorrect) { 
                feedback.className = 'feedback correct';
                feedback.textContent = '✅ 正確！答對了！';
                correctAnswers++;
                currentQ.isCorrect = true; 
            } else if (isCorrect && currentQ.isCorrect) {
                feedback.className = 'feedback correct';
                feedback.textContent = '✅ 正確！';
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = '❌ 錯誤！請看正確答案，或點選下一題。';
            }

            currentQ.studentInput = studentAnswer;
        }

        /** 進入下一題 */
        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        /** 結束測驗 */
        function endQuiz() {
            document.getElementById('quizArea').style.display = 'none';
            const resultDisplay = document.getElementById('quizResult');
            resultDisplay.style.display = 'block';
            resultDisplay.innerHTML = `
                測驗結束！<br>
                總共 ${currentQuiz.length} 題，答對 ${correctAnswers} 題。<br>
                正確率：${((correctAnswers / currentQuiz.length) * 100).toFixed(1)}%
                <hr>
                <h4>測驗結果詳情：</h4>
            `;
            
            currentQuiz.forEach((q, index) => {
                const correctAnswer = q.type === 0 ? q.meaning : q.word;
                const questionPrompt = q.type === 0 ? q.word : q.meaning;
                const status = q.isCorrect ? '✅ 答對' : '❌ 答錯';
                const statusColor = q.isCorrect ? 'green' : 'red';
                resultDisplay.innerHTML += `
                    <p style="border-left: 4px solid ${statusColor}; padding-left: 10px;">
                        <strong>${index + 1}. ${questionPrompt}</strong> <span style="color: ${statusColor};">(${status})</span><br>
                        您的答案: ${q.studentInput || '未作答'} <br>
                        正確答案: ${correctAnswer} (${q.partOfSpeech})<br>
                        提示使用: ${q.hintsUsed} 次
                    </p>
                `;
            });
        }

        // ** 介面控制 **

        /** Tab 切換功能 */
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) {
                evt.currentTarget.className += " active";
            } else {
                document.querySelector(`.tab-button[onclick*="${tabName}"]`).className += " active";
            }

            if (tabName === 'uploadTab' && !editingWord) {
                resetUploadState();
            }
        }

        // 初始化：啟動即時資料庫監聽
        window.onload = function() {
            if (window.firebaseUtils) {
                startRealtimeListener();
            } else {
                console.error("Firebase 函式庫未載入，可能影響資料庫連線。");
            }
            openTab(null, 'uploadTab'); 
        };
    </script>
