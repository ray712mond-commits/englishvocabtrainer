<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【最終完美版】我的英文單字練習本 - 共享雲端版</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // =========================================================
        // 您的 Firebase 專案設定 (已由 Gemini 填入)
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbmwpXx0mnZDd5xOcc2qlc3BkrE7_VFVw",
            authDomain: "englishvocabtrainer-b1de4.firebaseapp.com",
            projectId: "englishvocabtrainer-b1de4",
            storageBucket: "englishvocabtrainer-b1de4.firebasestorage.app",
            messagingSenderId: "415372743931",
            appId: "1:415372743931:web:3a734463227111d5704c5e"
        };

        // 初始化 Firebase App 和 Firestore
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore(); 
        
        window.db = db;
        window.vocabCollection = db.collection("vocabWords");
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; text-align: center; margin-bottom: 30px; }
        .tab-menu { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-button { 
            padding: 12px 20px; 
            cursor: pointer; 
            border: none; 
            background-color: #eee; 
            margin-right: 5px; 
            border-radius: 8px 8px 0 0; 
            font-weight: bold; 
            transition: background-color 0.3s;
        }
        .tab-button.active { 
            background-color: #007bff; 
            color: white; 
            border-bottom: 2px solid #007bff; 
        }
        /* 鎖定按鈕的樣式 */
        .tab-button.locked {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; transition: border-color 0.3s; }
        button { background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        button:hover:not(:disabled) { background-color: #218838; }
        
        /* 考卷樣式 */
        #quizArea { 
            border: 1px dashed #007bff; 
            padding: 20px; 
            border-radius: 8px; 
            margin-top: 20px;
        }
        .quiz-question-item {
            border-bottom: 1px dashed #ccc;
            padding: 15px 0;
            margin-bottom: 15px;
        }
        .quiz-question-item:last-child {
            border-bottom: none;
        }
        .question-prompt {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .quiz-answer-input {
            width: calc(100% - 130px);
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .hint-button {
            background-color: #ffc107;
            color: #333;
            padding: 8px 10px;
            font-size: 14px;
            vertical-align: top;
        }
        .hint-button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
        }
        .hint-text {
            margin-top: 8px;
            font-style: italic;
            color: #777;
            padding: 5px;
            border-left: 3px solid #ffc107;
            display: none;
        }
        .result-reveal {
            margin-top: 5px;
            padding: 5px;
            border-radius: 4px;
            font-weight: bold;
        }
        .result-correct { background-color: #d4edda; color: #155724; }
        .result-incorrect { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="container">
    <h1>【共享版】我的英文單字練習本</h1>
    <p style="text-align: center; color: red; font-weight: bold;">單字資料已同步至共享雲端資料庫！</p>

    <div class="tab-menu" id="tabMenu">
        <button class="tab-button active" id="uploadBtn" onclick="openTab(event, 'uploadTab')">上傳新單字</button>
        <button class="tab-button" id="quizSetupBtn" onclick="openTab(event, 'quizSetupTab')">開始抽考</button>
        <button class="tab-button" id="listBtn" onclick="openTab(event, 'listTab')">單字清單 (共享)</button>
    </div>

    <div id="uploadTab" class="tab-content active">
        <h2>上傳新單字</h2>
        <form id="uploadForm">
            <div class="form-group">
                <label for="word">單字 (英文):</label>
                <input type="text" id="word" required>
            </div>
            <div class="form-group">
                <label for="meaning">中文意思:</label>
                <input type="text" id="meaning" required>
            </div>
            <div class="form-group">
                <label for="partOfSpeech">詞性:</label>
                <select id="partOfSpeech" required>
                    <option value="">--請選擇--</option>
                    <option value="n">名詞 (n.)</option>
                    <option value="v">動詞 (v.)</option>
                    <option value="adj">形容詞 (adj.)</option>
                    <option value="adv">副詞 (adv.)</option>
                    <option value="prep">介系詞 (prep.)</option>
                    <option value="conj">連接詞 (conj.)</option>
                    <option value="phr">片語 (phr.)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="context">看到單字的地方/情況 (作為提示用):</label>
                <textarea id="context" required></textarea>
            </div>
            <button type="submit">儲存單字</button>
            <p id="uploadMessage" style="color: green; margin-top: 10px; display: none;"></p>
        </form>
    </div>

    <div id="quizSetupTab" class="tab-content">
        <h2>抽考設定</h2>
        <div class="form-group">
            <label for="quizCount">抽考題數:</label>
            <input type="number" id="quizCount" value="10" min="1" max="50">
        </div>
        <div class="form-group">
            <label for="quizRange">抽考範圍 (可選，留空為全部單字):</label>
            <input type="text" id="quizRange" placeholder="輸入部分中文意思或英文單字，以逗號分隔">
        </div>
        <div class="form-group">
            <label for="hintLimit">提示次數上限 (0~5):</label>
            <input type="number" id="hintLimit" value="3" min="0" max="5">
        </div>
        <button onclick="startQuiz()">開始測驗</button>
    </div>

    <div id="quizArea" class="tab-content">
        <h3>單字測驗 - <span id="hintStatus">剩餘提示次數：3</span></h3>
        <p>請在所有題目上作答完畢後，點擊最下方的「提交考卷」按鈕。</p>
        
        <div id="quizFormContainer">
            </div>

        <div id="quizActionButtons" style="text-align: center; margin-top: 30px;">
            <button onclick="submitQuiz()" style="background-color: #007bff; padding: 15px 30px;">提交考卷並批改</button>
        </div>
        
        <div id="quizResult" style="margin-top: 20px; font-size: 20px; font-weight: bold; display: none;"></div>
        <button id="restartButton" onclick="resetQuiz()" style="display: none; margin-top: 20px; background-color: #dc3545;">返回設定頁面</button>
    </div>


    <div id="listTab" class="tab-content">
        <h2>已上傳單字清單 (共享)</h2>
        <p>目前總計：<span id="vocabCount">0</span> 個單字</p>
        <table id="vocabTable" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
            <thead>
                <tr>
                    <th>單字 (詞性)</th>
                    <th>中文意思</th>
                    <th>情境 (提示)</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<script>
    // ** 全域變數 **
    let vocabList = [];
    let currentQuiz = []; 
    let editingWord = null; 
    let isQuizActive = false; 

    let totalHintsUsed = 0; 
    let hintLimit = 3; 

    // ** 資料儲存 (使用 Firebase Firestore) **
    
    /** 啟動即時監聽，從 Firestore 讀取所有單字並更新全域變數 */
    function startRealtimeListener() {
        if (!window.db || !window.vocabCollection) {
            console.error("Firebase 函式庫未載入！請檢查 CDN 腳本是否正確。");
            document.getElementById('vocabCount').textContent = '載入失敗 (Firebase 錯誤)';
            return;
        }

        window.vocabCollection.onSnapshot((snapshot) => {
            vocabList = [];
            snapshot.forEach((doc) => {
                vocabList.push({ id: doc.id, ...doc.data() });
            });
            vocabList.sort((a, b) => a.word.localeCompare(b.word));
            
            renderVocabList(); 
        }, (error) => {
            console.error("Error listening to Firestore: ", error);
            document.getElementById('vocabCount').textContent = '載入失敗';
        });
    }

    // ** 1. 上傳/更新單字功能 (寫入 Firestore) **

    function setupFormListener() {
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            
            const newWordData = {
                word: document.getElementById('word').value.trim(),
                meaning: document.getElementById('meaning').value.trim(),
                partOfSpeech: document.getElementById('partOfSpeech').value,
                context: document.getElementById('context').value.trim(),
            };

            const msg = document.getElementById('uploadMessage');

            try {
                if (editingWord) {
                    await window.vocabCollection.doc(editingWord.id).update(newWordData);
                    msg.textContent = `成功更新單字: ${newWordData.word}`;
                } else {
                    const existing = vocabList.find(v => v.word.toLowerCase() === newWordData.word.toLowerCase());
                    if (existing) {
                        alert(`單字 "${newWordData.word}" 已經存在於清單中！`);
                        submitButton.disabled = false;
                        return;
                    }

                    await window.vocabCollection.add({ 
                        ...newWordData, 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                    msg.textContent = `成功儲存單字: ${newWordData.word} (已同步到雲端)`;
                }

                document.getElementById('uploadForm').reset();
                resetUploadState(); 
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
                
            } catch (error) {
                console.error("Error saving document: ", error);
                alert("儲存/更新失敗！請檢查 Firebase 權限或網路連線。");
            } finally {
                submitButton.disabled = false;
            }
        });
    }

    /** 重設上傳表單的狀態 */
    function resetUploadState() {
        editingWord = null;
        document.getElementById('uploadForm').querySelector('button[type="submit"]').textContent = '儲存單字';
        document.getElementById('uploadTab').querySelector('h2').textContent = '上傳新單字';
    }


    // ** 3. 單字清單顯示/操作 **

    function renderVocabList() {
        const tbody = document.getElementById('vocabTable').querySelector('tbody');
        tbody.innerHTML = '';
        document.getElementById('vocabCount').textContent = vocabList.length;

        vocabList.forEach(vocab => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${vocab.word} (${vocab.partOfSpeech})</td>
                <td>${vocab.meaning}</td>
                <td>${vocab.context}</td>
                <td>
                    <button style="background-color: #007bff; margin-right: 5px;" onclick="editVocab('${vocab.id}')">修改</button>
                    <button style="background-color: #dc3545;" onclick="deleteVocab('${vocab.id}')">刪除</button>
                </td>
            `;
        });
    }

    function editVocab(docId) {
        const vocab = vocabList.find(v => v.id === docId);
        if (!vocab) return;

        editingWord = vocab;
        
        document.getElementById('word').value = vocab.word;
        document.getElementById('meaning').value = vocab.meaning;
        document.getElementById('partOfSpeech').value = vocab.partOfSpeech;
        document.getElementById('context').value = vocab.context;

        document.getElementById('uploadForm').querySelector('button[type="submit"]').textContent = '更新單字';
        document.getElementById('uploadTab').querySelector('h2').textContent = `修改單字: ${vocab.word}`;

        openTab(null, 'uploadTab');
    }

    async function deleteVocab(docId) {
        if (confirm('確定要刪除這個單字嗎？此操作會從共享資料庫中永久移除！')) {
            try {
                await window.vocabCollection.doc(docId).delete();
            } catch (error) {
                console.error("Error deleting document: ", error);
                alert("刪除失敗！請檢查 Firebase 連線或權限。");
            }
        }
    }

    // ** 2. 抽考功能 - 核心重寫為考卷模式 **

    /** 開始測驗：生成所有題目並鎖定頁面 */
    function startQuiz() {
        if (vocabList.length === 0) {
            alert('單字清單是空的，請先上傳單字！');
            return;
        }

        const count = parseInt(document.getElementById('quizCount').value);
        const rangeText = document.getElementById('quizRange').value.trim();
        const hintLimitInput = parseInt(document.getElementById('hintLimit').value);
        
        // 設定全域提示限制
        hintLimit = Math.min(Math.max(hintLimitInput, 0), 5); // 允許 0 個提示
        totalHintsUsed = 0; // 重置已使用次數

        // 篩選範圍邏輯 (不變)
        let filteredVocab = vocabList;
        if (rangeText) {
            const keywords = rangeText.toLowerCase().split(',').map(s => s.trim());
            filteredVocab = vocabList.filter(vocab => {
                return keywords.some(keyword => 
                    vocab.word.toLowerCase().includes(keyword) || 
                    vocab.meaning.includes(keyword)
                );
            });
        }

        if (filteredVocab.length === 0) {
            alert('找不到符合範圍的單字，請修改抽考範圍！');
            return;
        }
        
        // 隨機抽選題目
        currentQuiz = [];
        const availableVocab = [...filteredVocab]; 
        const actualCount = Math.min(count, filteredVocab.length);
        
        for (let i = 0; i < actualCount; i++) {
            const randomIndex = Math.floor(Math.random() * availableVocab.length);
            const selectedVocab = availableVocab.splice(randomIndex, 1)[0];
            const type = Math.floor(Math.random() * 2); // 0=英翻中, 1=中翻英
            
            currentQuiz.push({
                ...selectedVocab,
                type: type, 
                id: selectedVocab.id,
                isAnswered: false,
                isCorrect: false,
                studentInput: '',
                hintUsed: false, 
                questionIndex: i + 1
            });
        }

        // 渲染考卷
        renderQuizForm();
        // 鎖定分頁並切換到測驗頁面
        lockTabs();
        openTab(null, 'quizArea');
        isQuizActive = true;
    }

    /** 渲染所有題目到考卷容器 */
    function renderQuizForm() {
        const container = document.getElementById('quizFormContainer');
        const hintStatus = document.getElementById('hintStatus');
        container.innerHTML = '';
        
        hintStatus.textContent = `剩餘提示次數：${hintLimit - totalHintsUsed}`;
        document.getElementById('quizResult').style.display = 'none';
        document.getElementById('restartButton').style.display = 'none';
        document.getElementById('quizActionButtons').style.display = 'block';

        currentQuiz.forEach((q) => {
            const prompt = q.type === 0 
                ? `${q.word} (${q.partOfSpeech}) 的中文意思是？` // 英翻中
                : `「${q.meaning}」的英文單字是？`; // 中翻英
            
            const isHintDisabled = totalHintsUsed >= hintLimit;
            const remainingHints = hintLimit - totalHintsUsed;

            const itemHtml = `
                <div class="quiz-question-item" data-id="${q.id}" data-index="${q.questionIndex}">
                    <div class="question-prompt">
                        ${q.questionIndex}. ${prompt}
                    </div>
                    <div>
                        <input type="text" class="quiz-answer-input" id="answer-${q.id}" placeholder="請在此輸入答案" autocomplete="off">
                        <button class="hint-button" id="hint-btn-${q.id}" onclick="showHint(this, '${q.id}')" ${isHintDisabled ? 'disabled' : ''}>
                            提示 (剩餘 ${remainingHints})
                        </button>
                    </div>
                    <div id="hint-text-${q.id}" class="hint-text">情境提示：${q.context}</div>
                    <div id="result-text-${q.id}" class="result-reveal" style="display:none;"></div>
                </div>
            `;
            container.innerHTML += itemHtml;
        });
    }

    /** 顯示提示 (獨立到每題，但共用配額) */
    function showHint(button, docId) {
        
        const question = currentQuiz.find(q => q.id === docId);
        if (!question) return;

        if (totalHintsUsed >= hintLimit) {
            button.disabled = true;
            return;
        }

        // 只有在該題還沒用過提示時，才扣除配額
        if (!question.hintUsed) {
            totalHintsUsed++; // 總提示次數 -1
            question.hintUsed = true;
        }

        // 更新 UI
        const remainingHints = hintLimit - totalHintsUsed;
        document.getElementById('hintStatus').textContent = `剩餘提示次數：${remainingHints}`;
        document.getElementById(`hint-text-${docId}`).style.display = 'block';
        button.disabled = true; // 該題按鈕禁用

        // 更新所有提示按鈕的剩餘次數顯示和禁用狀態
        document.querySelectorAll('.hint-button').forEach(btn => {
            btn.textContent = `提示 (剩餘 ${remainingHints})`;
            if (remainingHints <= 0) {
                 btn.disabled = true;
            }
        });
    }

    /** 提交考卷並批改 */
    function submitQuiz() {
        let correctCount = 0;
        
        // 1. 儲存答案
        currentQuiz.forEach(q => {
            const inputElement = document.getElementById(`answer-${q.id}`);
            q.studentInput = inputElement.value.trim();
        });

        // 2. 批改並顯示結果
        currentQuiz.forEach(q => {
            const resultElement = document.getElementById(`result-text-${q.id}`);
            const inputElement = document.getElementById(`answer-${q.id}`);
            const hintButton = document.getElementById(`hint-btn-${q.id}`);

            let correctAnswer = q.type === 0 ? q.meaning : q.word;
            // 簡化批改邏輯：英翻中(包含即可)，中翻英(完全匹配)
            let isCorrect = q.type === 0
                ? correctAnswer.toLowerCase().includes(q.studentInput.toLowerCase())
                : q.studentInput.toLowerCase() === correctAnswer.toLowerCase();
            
            q.isCorrect = isCorrect;
            
            // 禁用輸入框和提示按鈕
            inputElement.disabled = true;
            if (hintButton) hintButton.disabled = true;

            // 顯示批改結果
            resultElement.style.display = 'block';
            if (isCorrect) {
                correctCount++;
                resultElement.className = 'result-reveal result-correct';
                resultElement.innerHTML = `✅ **正確！**`;
            } else {
                resultElement.className = 'result-reveal result-incorrect';
                resultElement.innerHTML = `❌ **錯誤！** 正確答案是：${correctAnswer} (${q.type === 0 ? '中文' : '英文'})`;
            }
        });

        // 3. 顯示總成績
        const total = currentQuiz.length;
        document.getElementById('quizActionButtons').style.display = 'none';
        document.getElementById('hintStatus').textContent = `測驗已完成。共使用 ${totalHintsUsed} 次提示。`;
        
        const resultDisplay = document.getElementById('quizResult');
        resultDisplay.style.display = 'block';
        resultDisplay.innerHTML = `
            🎉 測驗結果：<br>
            總共 ${total} 題，答對 **${correctCount}** 題。<br>
            正確率：**${((correctCount / total) * 100).toFixed(1)}%**
        `;

        // 顯示返回按鈕
        document.getElementById('restartButton').style.display = 'inline-block';
        isQuizActive = false;
        unlockTabs();
    }

    /** 重置測驗狀態並返回設定頁面 */
    function resetQuiz() {
        currentQuiz = [];
        totalHintsUsed = 0;
        hintLimit = 3;
        isQuizActive = false;
        unlockTabs();
        openTab(null, 'quizSetupTab');
        document.getElementById('quizArea').style.display = 'none';
    }


    // ** 介面控制 **

    /** 鎖定所有非測驗相關的 Tab */
    function lockTabs() {
        const buttons = document.querySelectorAll('#tabMenu .tab-button');
        buttons.forEach(button => {
            if (button.id !== 'quizSetupBtn' && button.id !== 'quizArea') {
                 button.classList.add('locked');
                 button.disabled = true;
            } else {
                button.disabled = false;
            }
        });
    }

    /** 解鎖所有 Tab */
    function unlockTabs() {
        const buttons = document.querySelectorAll('#tabMenu .tab-button');
        buttons.forEach(button => {
             button.classList.remove('locked');
             button.disabled = false;
        });
    }


    /** Tab 切換功能 */
    function openTab(evt, tabName) {
        // 如果測驗進行中，且嘗試切換到非測驗頁面，則阻止 (解決作弊問題)
        if (isQuizActive && tabName !== 'quizArea' && tabName !== 'quizSetupTab') {
            alert('測驗正在進行中，請先完成考卷！');
            return;
        }
        
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            // 只有在非鎖定狀態下才移除 active class
            if (!tablinks[i].classList.contains('locked')) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
        }
        document.getElementById(tabName).style.display = "block";
        
        if (evt) {
            evt.currentTarget.className += " active";
        } else {
            const targetButton = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
            if (targetButton) {
                targetButton.className += " active";
            }
        }

        if (tabName === 'uploadTab' && !editingWord) {
            resetUploadState();
        }
    }

    // 確保在所有 DOM 元素載入後才執行程式碼
    window.onload = function() {
        setupFormListener();
        startRealtimeListener();
        openTab(null, 'uploadTab'); 
    };
</script>

</body>
</html>
